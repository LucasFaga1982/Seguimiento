<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seguimiento de Pedidos ‚Äî Docentes Brown</title>
<style>
  :root{
    --primary:#24496e;   /* azul DB */
    --accent:#ef9963;    /* salm√≥n DB */
    --bg:#f3efdc;        /* crema DB */
    --purple:#4d3069;    /* violeta DB */
    --text:#1f2937;
    --ok:#0ea5e9;
    --warn:#eab308;
    --danger:#dc2626;
    --muted:#6b7280;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    background:var(--bg); color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:var(--primary); color:#fff;
    box-shadow:0 2px 8px rgba(0,0,0,.2);
  }
  header .title{ font-weight:700; letter-spacing:.3px }
  header .login-btn{
    background:var(--accent); color:#1b1b1b; border:none; border-radius:999px;
    padding:8px 12px; font-weight:700; cursor:pointer;
  }
  main{ padding:14px; max-width:980px; margin:0 auto; }
  .grid{
    display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px;
  }
  .card{
    background:var(--card);
    border:2px solid #1f3d58; border-radius:16px; padding:12px 12px 14px;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    position:relative; transition:transform .08s ease;
  }
  .card:hover{ transform:translateY(-2px); }
  .card .top{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin-bottom:6px;
  }
  .docente{ font-weight:800; color:#123; }
  .pedido{ font-size:12px; color:var(--muted) }
  .etapa{
    display:inline-block; padding:6px 10px; border-radius:999px;
    background:var(--accent); font-weight:700; font-size:12px; color:#1b1b1b;
  }
  .overdue-dot{
    position:absolute; right:10px; top:10px; width:10px; height:10px;
    background:var(--danger); border-radius:999px; box-shadow:0 0 0 3px rgba(220,38,38,.15);
  }
  .muted{ color:var(--muted); font-size:12px; margin-top:4px; }

  /* Login modal */
  .modal, .actions-modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.45); z-index:50; padding:16px;
  }
  .modal.active, .actions-modal.active{ display:flex; }
  .modal .box, .actions-modal .box{
    width:100%; max-width:420px; background:#fff; border-radius:18px;
    box-shadow:0 20px 50px rgba(0,0,0,.3); padding:16px;
  }
  .box h3{ margin:0 0 12px 0; color:var(--primary) }
  .row{ display:flex; gap:10px; margin-bottom:10px; }
  .row input, .row select{
    flex:1; padding:10px 12px; border:1px solid #cbd5e1; border-radius:12px; font-size:16px;
  }
  .btn{
    appearance:none; border:none; border-radius:12px; padding:10px 14px;
    font-weight:800; cursor:pointer;
  }
  .btn.primary{ background:var(--primary); color:#fff; }
  .btn.accent{ background:var(--accent); color:#1b1b1b; }
  .btn.ghost{ background:transparent; color:var(--primary); border:2px solid var(--primary); }
  .btn.whatsapp{ background:#25d366; color:#08340f; }
  .btn.danger{ background:var(--danger); color:#fff; }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; }
  .box .label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
  .x{ position:absolute; right:12px; top:10px; background:transparent; border:none; font-size:22px; cursor:pointer; color:#6b7280 }

  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.3); z-index:60; display:none;
  }
  .toast.show{ display:block; }

  /* WhatsApp notify footer */
  .notify-bar{
    position:fixed; bottom:12px; left:12px; right:12px; z-index:45;
    display:none; background:#fff; border:2px dashed var(--warn); color:#1b1b1b;
    border-radius:16px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.2);
  }
  .notify-bar.active{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .notify-bar b{ color:#92400e }
  a{ color:inherit; text-decoration:none; }
</style>
</head>
<body>
  <header>
    <div class="title">üì¶ Seguimiento de Pedidos ‚Äî <span style="font-weight:300">Docentes Brown</span></div>
    <button class="login-btn" id="loginBtn">Ingresar</button>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <!-- Login -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <button class="x" id="closeLogin" title="Cerrar">√ó</button>
      <h3 id="loginTitle">Acceso</h3>
      <div class="row"><input id="user" placeholder="Usuario" autocomplete="username" /></div>
      <div class="row"><input id="pass" placeholder="Contrase√±a" type="password" autocomplete="current-password" /></div>
      <div class="btn-row">
        <button class="btn primary" id="doLogin">Ingresar</button>
        <button class="btn ghost" id="cancelLogin">Cancelar</button>
      </div>
      <div class="muted">Usuario: <b>docentesbrown</b> ‚Äî Contrase√±a: <b>NestorVive</b></div>
    </div>
  </div>

  <!-- Acciones por tarjeta -->
  <div class="actions-modal" id="actionsModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="actionsTitle">
      <button class="x" id="closeActions" title="Cerrar">√ó</button>
      <h3 id="actionsTitle">Acciones</h3>
      <div class="muted" id="selectedInfo"></div>
      <div class="label" style="margin-top:10px">Contacto</div>
      <div class="btn-row">
        <a class="btn whatsapp" id="waBtn" target="_blank" rel="noopener">üí¨ WhatsApp</a>
      </div>
      <div class="label" style="margin-top:10px">Actualizar etapa</div>
      <div class="btn-row">
        <button class="btn accent etapabtn" data-etapa="CARGADO">CARGADO</button>
        <button class="btn accent etapabtn" data-etapa="EN PRODUCCI√ìN">EN PRODUCCI√ìN</button>
        <button class="btn accent etapabtn" data-etapa="PARA ENTREGAR">PARA ENTREGAR</button>
        <button class="btn accent etapabtn" data-etapa="FINALIZADO">FINALIZADO</button>
      </div>
    </div>
  </div>

  <!-- Aviso WhatsApp atrasos -->
  <div class="notify-bar" id="notifyBar">
    <div>‚ö†Ô∏è <b id="overdueCount">0</b> pedidos con m√°s de 7 d√≠as sin cambios.</div>
    <a class="btn whatsapp" id="notifyLink" target="_blank" rel="noopener">Avisar por WhatsApp</a>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
  // ===================== CONFIG =====================
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-9IeM2BVQBw1SQEkbdmmp2yLMVzG-4krVRmc-JdWb6BIX4MSTLVL8DbYyGbm864ChHRvICrsad7Hi/pub?output=csv';
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbybFdchci2C5tbI3irTNcbXavFpsaA6N_0DXW7Rr6iilCGzEu0w_A4gQ9SsxTdzDs8yIA/exec';

  const ADMIN_USER = 'docentesbrown';
  const ADMIN_PASS = 'NestorVive';

  // ===================== STATE =====================
  let data = [];            // registros parseados
  let isAdmin = false;      // sesi√≥n
  let selected = null;      // tarjeta seleccionada para acciones
  let overdues = [];        // atrasados > 7 d√≠as

  // ===================== HELPERS =====================
  function showToast(msg, ms=2200){
    const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), ms);
  }

  function parseCSV(text){
    // Parser b√°sico que soporta campos entrecomillados (comas internas y comillas escapadas)
    const rows=[]; let i=0, cur='', inQ=false, row=[];
    while(i<text.length){
      const c=text[i];
      if(inQ){
        if(c==='"'){
          if(text[i+1]==='"'){ cur+='"'; i++; }
          else { inQ=false; }
        }else cur+=c;
      }else{
        if(c==='"'){ inQ=true; }
        else if(c===','){ row.push(cur); cur=''; }
        else if(c==='\n' || c==='\r'){
          if(c==='\r' && text[i+1]==='\n') i++;
          row.push(cur); rows.push(row); row=[]; cur='';
        }else cur+=c;
      }
      i++;
    }
    if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
    return rows.filter(r=>r.length>1 || (r[0]&&r[0].trim()!==''));
  }

  function parseDateCell(s){
    if(!s) return null;
    const t=s.trim();
    let d=new Date(t);
    if(!isNaN(d)) return d;
    const m=t.match(/^(\d{1,2})[\/\\-](\d{1,2})[\/\\-](\d{2,4})$/);
    if(m){
      const dd=+m[1], mm=+m[2]-1, yyyy=+m[3]<100?2000+(+m[3]):+m[3];
      d=new Date(yyyy,mm,dd);
      if(!isNaN(d)) return d;
    }
    return null;
  }

  function daysBetween(a,b){ return Math.floor((a - b) / 86400000); }

  function formatPhoneAR(raw){
    if(!raw) return '';
    let n=(raw+'').replace(/\\D/g,'');
    if(n.startsWith('549')) return n;
    if(n.startsWith('54') && !n.startsWith('549')) return '549'+n.slice(2);
    if(n.startsWith('0')) n=n.slice(1);
    if(n.startsWith('15')) n=n.slice(2);
    if(n.length===10 && n.startsWith('11')) return '549'+n;
    if(n.length>=10) return '54'+(n.startsWith('9')?'':'9')+n;
    return n;
  }

  function etapaBadge(etapa){
    return `<span class="etapa">${etapa || '‚Äî'}</span>`;
  }

  function openModal(el){ el.classList.add('active'); el.setAttribute('aria-hidden','false'); }
  function closeModal(el){ el.classList.remove('active'); el.setAttribute('aria-hidden','true'); }

  function authUpdateRow(row, etapa){
    return new Promise((resolve)=> {
      const url = `${SCRIPT_URL}?action=update&row=${encodeURIComponent(row)}&etapa=${encodeURIComponent(etapa)}&_=${Date.now()}`;
      const img = new Image();
      img.onload = ()=> resolve();
      img.onerror = ()=> resolve();
      img.src = url;
    });
  }

  // ===================== RENDER =====================
  function render(){
    const grid=document.getElementById('grid');
    grid.innerHTML='';

    overdues = [];
    const now=new Date();

    data.forEach(rec=>{
      const d=parseDateCell(rec.fechaEtapa);
      const days = d ? daysBetween(now, d) : null;
      const isFinal = (rec.etapa||'').toUpperCase().trim()==='FINALIZADO';
      const isOver = !isFinal && d && days>7;

      if(isOver) overdues.push({pedido:rec.pedido, docente:rec.docente, etapa:rec.etapa, dias:days});

      const card=document.createElement('div');
      card.className='card';
      card.innerHTML = `
        ${isOver ? '<div class="overdue-dot" title="Atrasado (+7 d√≠as)"></div>' : ''}
        <div class="top">
          <div>
            <div class="docente">${rec.docente || '‚Äî'}</div>
            <div class="pedido">Pedido: <b>${rec.pedido || '‚Äî'}</b></div>
          </div>
          <div>${etapaBadge(rec.etapa)}</div>
        </div>
        <div class="muted">${d ? 'Fecha etapa: '+d.toLocaleDateString() : 'Sin fecha de etapa'}</div>
      `;

      if(isAdmin){
        card.style.cursor='pointer';
        card.addEventListener('click', ()=>{
          selected = rec;
          document.getElementById('selectedInfo').innerHTML =
            `Docente: <b>${rec.docente || '‚Äî'}</b><br>Pedido: <b>${rec.pedido || '‚Äî'}</b><br>Etapa actual: <b>${rec.etapa || '‚Äî'}</b>`;
          const phone = formatPhoneAR(rec.tel);
          const msg = `Hola, nos comunicamos de Docentes Brown, tu calificador 2026 ya se encuentra finalizado.`;
          const waHref = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
          const waBtn = document.getElementById('waBtn');
          if(phone){ waBtn.href = waHref; waBtn.classList.remove('danger'); waBtn.textContent='üí¨ WhatsApp'; }
          else { waBtn.href='#'; waBtn.classList.add('danger'); waBtn.textContent='‚ö†Ô∏è Sin tel√©fono'; }
          openModal(document.getElementById('actionsModal'));
        });
      }

      grid.appendChild(card);
    });

    // Notify bar for overdues
    const bar=document.getElementById('notifyBar');
    if(overdues.length>0){
      document.getElementById('overdueCount').textContent = overdues.length;
      const list = overdues.slice(0,10).map(o=>`Pedido ${o.pedido} (${o.docente}) ‚Äî ${o.dias} d√≠as en ${o.etapa}`).join('\\n');
      const extra = overdues.length>10 ? `\\n‚Ä¶y ${overdues.length-10} m√°s.` : '';
      const notifyMsg = `Alerta pedidos con m√°s de 7 d√≠as sin cambios (no finalizados):\\n${list}${extra}`;
      const adminPhone = formatPhoneAR('1153196358');
      document.getElementById('notifyLink').href = `https://wa.me/${adminPhone}?text=${encodeURIComponent(notifyMsg)}`;
      bar.classList.add('active');
    }else{
      bar.classList.remove('active');
    }
  }

  // ===================== LOAD CSV =====================
  async function loadData(){
    try{
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const rows = parseCSV(text);
      if(!rows.length) { showToast('No hay datos'); return; }

      const header = rows[0];
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        data.push({
          sheetRow: i+1,           // fila real en la hoja (header es fila 1, primera data es 2)
          docente: r[2] || '',      // C
          tel:     r[3] || '',      // D
          correo:  r[5] || '',      // F
          etapa:   r[25] || '',     // Z
          pedido:  r[26] || '',     // AA
          fechaEtapa: r[27] || ''   // AB
        });
      }

      render();
    }catch(err){
      console.error(err);
      showToast('Error al cargar el CSV');
    }
  }

  // ===================== EVENTS =====================
  // Login
  const loginBtn=document.getElementById('loginBtn');
  const loginModal=document.getElementById('loginModal');
  loginBtn.addEventListener('click', ()=>{
    if(isAdmin){
      isAdmin=false; localStorage.removeItem('db_admin');
      loginBtn.textContent='Ingresar';
      showToast('Sesi√≥n cerrada');
      render();
    }else{
      openModal(loginModal);
      setTimeout(()=>document.getElementById('user').focus(),10);
    }
  });
  document.getElementById('doLogin').addEventListener('click', ()=>{
    const u=document.getElementById('user').value.trim();
    const p=document.getElementById('pass').value;
    if(u==='docentesbrown' && p==='NestorVive'){
      isAdmin=true; localStorage.setItem('db_admin','1');
      loginBtn.textContent='Salir';
      closeModal(loginModal);
      showToast('Sesi√≥n iniciada');
      render();
    }else{
      showToast('Usuario o contrase√±a inv√°lidos');
    }
  });
  document.getElementById('cancelLogin').addEventListener('click', ()=> closeModal(loginModal));
  document.getElementById('closeLogin').addEventListener('click', ()=> closeModal(loginModal));
  loginModal.addEventListener('click', (e)=>{ if(e.target===loginModal) closeModal(loginModal); });

  // Acciones por tarjeta
  const actionsModal=document.getElementById('actionsModal');
  document.getElementById('closeActions').addEventListener('click', ()=> closeModal(actionsModal));
  actionsModal.addEventListener('click', (e)=>{ if(e.target===actionsModal) closeModal(actionsModal); });

  document.querySelectorAll('.etapabtn').forEach(btn=>{
    btn.addEventListener('click', async (ev)=>{
      if(!isAdmin || !selected) return;
      const nueva = ev.currentTarget.getAttribute('data-etapa');
      const row = Number(selected.sheetRow); // fila real en la hoja
      // Optimista: actualizamos UI ya y disparamos update
      selected.etapa = nueva;
      selected.fechaEtapa = new Date().toISOString().slice(0,10);
      render();
      closeModal(actionsModal);

      await authUpdateRow(row, nueva);
      showToast('Etapa actualizada');
    });
  });

  // Restaurar sesi√≥n si exist√≠a
  if(localStorage.getItem('db_admin')==='1'){
    isAdmin=true; document.getElementById('loginBtn').textContent='Salir';
  }

  // GO
  loadData();
</script>
</body>
</html>
