<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seguimiento de Productos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
    .login { max-width: 350px; margin: 50px auto; background: #fff; padding: 2em; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);}
    .container { max-width: 900px; margin: 20px auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      display: flex; flex-direction: column; justify-content: space-between; min-height: 120px;
    }
    .card-title { font-weight: bold; font-size: 1.1em; }
    .card-stage { margin: 0.5em 0; color: #555; }
    .card-actions { display: flex; gap: 0.5em; margin-top: 1em; }
    .btn { border: none; border-radius: 5px; padding: 0.6em 1em; background: #3498db; color: #fff; cursor: pointer; font-size: 1em;}
    .btn.whatsapp { background: #25d366; }
    .btn.stage { background: #ff9800; }
    .logout { float: right; margin: 1em; }
    .editor-badge { font-size:0.8em; color:#fff; background:#2c3e50; padding:2px 8px; border-radius:5px; margin-left:5px;}
    .alert { background: #ffeb3b; color: #222; padding: 10px; border-radius: 5px; margin-bottom: 1em; }
  </style>
</head>
<body>
  <button class="logout btn" style="display:none" onclick="logout()">Salir</button>
  <div id="main"></div>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-9IeM2BVQBw1SQEkbdmmp2yLMVzG-4krVRmc-JdWb6BIX4MSTLVL8DbYyGbm864ChHRvICrsad7Hi/pub?output=csv";
const APP_SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbzvn0Ts418vORNHBv0QFVgWzjVSDqAtX8d8GIJauipqOIkST65GtiC_gmq6Z_c9-qFyVg/exec"; // Cambia al tuyo
const LOGIN_USER = "DOCENTESBROWN";
const LOGIN_PASS = "NestorVive";

// Estapas posibles, personaliza si querés
const ETAPAS = ["cargado", "en fabricación", "terminada", "para entrega", "finalizado"];

let isEditor = false;
let pedidos = [];

function showLogin() {
  document.querySelector('.logout').style.display = 'none';
  document.getElementById('main').innerHTML = `
    <div class="login">
      <h2>Ingreso de Editor</h2>
      <input type="text" id="user" placeholder="Usuario" class="form" style="width:100%;margin-bottom:1em;">
      <input type="password" id="pass" placeholder="Clave" class="form" style="width:100%;margin-bottom:1em;">
      <button class="btn" onclick="login()">Ingresar</button>
    </div>
  `;
}
window.logout = function() {
  localStorage.removeItem("editor");
  isEditor = false;
  showPedidos();
}

window.login = function() {
  const user = document.getElementById('user').value;
  const pass = document.getElementById('pass').value;
  if (user === LOGIN_USER && pass === LOGIN_PASS) {
    isEditor = true;
    localStorage.setItem("editor", "1");
    showPedidos();
  } else {
    alert("Usuario o clave incorrectos");
  }
}

function fetchPedidos() {
  return fetch(SHEET_CSV_URL).then(r=>r.text()).then(parseCSV);
}

function parseCSV(str) {
  // Simple CSV parser
  let rows = str.trim().split("\n").map(l => l.split(","));
  const headers = rows.shift().map(h=>h.trim());
  return rows.map(r=>{
    let obj={};
    r.forEach((val,i)=>obj[headers[i]]=val.trim());
    return obj;
  });
}

function timeDiffDays(dateStr) {
  let d = new Date(dateStr);
  let now = new Date();
  return Math.floor((now-d)/(1000*60*60*24));
}

function showPedidos() {
  document.querySelector('.logout').style.display = isEditor ? 'inline-block' : 'none';
  document.getElementById('main').innerHTML = `<div style="text-align:center;margin:1em;"><b>Cargando datos...</b></div>`;
  fetchPedidos().then(data => {
    pedidos = data;
    renderPedidos();
    if (isEditor) checkOldPedidos();
  });
}

function renderPedidos() {
  let html = `<div class="container">`;
  if (isEditor) html += `<div class="alert">Modo Editor activo <span class="editor-badge">EDITORES</span></div>`;
  html += `<div class="grid">`;
  pedidos.forEach((p, idx) => {
    const nombre = p["Nombre"] || p["nombre"] || p["Producto"] || p["producto"] || p[Object.keys(p)[2]];
    const etapa = p["Etapa"] || p["etapa"] || p[Object.keys(p)[25]];
    const celular = (p["Celular"] || p["celular"] || p[Object.keys(p)[3]]).replace(/\D/g, "");
    const contacto = p["Contacto"] || p["contacto"] || p[Object.keys(p)[5]];
    const fechaEtapa = p["FechaEtapa"] || p["fechaetapa"] || p[Object.keys(p)[28]] || new Date().toISOString().substring(0,10);
    const msg = encodeURIComponent(`Hola! Tu pedido "${nombre}" está en la etapa "${etapa}".`);
    html += `
      <div class="card">
        <div class="card-title">${nombre}</div>
        <div class="card-stage">Etapa: <b>${etapa}</b></div>
        <div class="card-actions">
          <a class="btn whatsapp" target="_blank" href="https://wa.me/54${celular}?text=${msg}">WhatsApp</a>
          ${isEditor ? `<button class="btn stage" onclick="cambiarEtapa(${idx})">Cambiar etapa</button>` : ""}
        </div>
      </div>
    `;
  });
  html += `</div></div>`;
  document.getElementById('main').innerHTML = html;
}

window.cambiarEtapa = function(idx) {
  const p = pedidos[idx];
  let etapaActual = p["Etapa"] || p["etapa"] || p[Object.keys(p)[23]];
  let etapaIdx = ETAPAS.indexOf(etapaActual);
  let nextEtapa = ETAPAS[(etapaIdx+1)%ETAPAS.length];
  if (!confirm(`¿Seguro que querés cambiar la etapa a "${nextEtapa}"?`)) return;
  // Llama a Apps Script para actualizar la fila correspondiente
  fetch(`${APP_SCRIPT_API_URL}?action=update&row=${idx+2}&etapa=${encodeURIComponent(nextEtapa)}`,{method:'GET'})
    .then(r=>r.json())
    .then(resp=>{
      if(resp.success){
        alert("Etapa actualizada.");
        // Enviar mail automático vía Apps Script
        let contacto = p["Contacto"] || p["contacto"] || p[Object.keys(p)[5]];
        fetch(`${APP_SCRIPT_API_URL}?action=mail&to=${encodeURIComponent(contacto)}&etapa=${encodeURIComponent(nextEtapa)}`,{method:'GET'});
        showPedidos();
      }else{
        alert("Error al actualizar: "+resp.error);
      }
    });
}

function checkOldPedidos() {
  pedidos.forEach((p, idx) => {
    const fechaEtapa = p["FechaEtapa"] || p["fechaetapa"] || p[Object.keys(p)[24]];
    if (fechaEtapa && timeDiffDays(fechaEtapa) >= 7) {
      // Notificación local simple, para push necesitas backend/service worker
      setTimeout(()=>{
        alert(`El pedido "${p["Nombre"]||p["Producto"]}" lleva más de 7 días en la misma etapa ("${p["Etapa"]}").`);
      }, 1000);
      // Puedes enviar email de alerta a los editores usando Apps Script
      fetch(`${APP_SCRIPT_API_URL}?action=alerta&pedido=${encodeURIComponent(p["Nombre"]||p["Producto"])}&dias=${timeDiffDays(fechaEtapa)}`,{method:'GET'});
    }
  });
}

// Inicio
if (localStorage.getItem("editor")) { isEditor = true; }
showPedidos();
</script>
</body>
</html>
